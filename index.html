<!DOCTYPE html>
<style>
#keyboard-wrapper{
    width: 100%;
    height: 30%;
}
.column {
  float: left;
  width: 5%;
  padding: 10px;
  height: 300px; /* Should be removed. Only for demonstration */
  border-color: black;
  border-style:solid;
  text-align: center;
}
.column1 {
  float: left;
  width: 2.2%;
  padding: 10px;
  height: 150px; /* Should be removed. Only for demonstration */
  border-color: black;
  border-style:solid;
  text-align: center;
}
.column2 {
  float: left;
  width: 1.2%;
  padding: 10px;
  height: 150px; /* Should be removed. Only for demonstration */
  /* border-color: black;
  border-style:solid; */
  /* background-color: white; */
  text-align: center;
}
</style>
<html lang="en">
    <script src="./js/harmony.js"></script>
    <script src="./js/canvasjs.min.js"></script>
    <!-- <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script> -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <div class="row" id="keyboard-wrapper" style="display: inline-block;"> 
        <div class="row">
            <label>Play along? </label>
            <input type="checkbox" onclick="togglePlayAlong(this.checked)">
        </div>
        <div class="row" style="padding: 20px;">
            <label>SELECT INPUT DEVICE:</label><br>
            <input type="radio" id="micInput" name="inputType" value="micInput" onclick="changeInput('mic')">
            <label for="micInput">Mic</label><br>
            <input type="radio" id="fileInput" name="inputType" checked value="fileInput" onclick="changeInput('file')">
            <label for="fileInput">File</label><br>
        </div>
        <div class="row"><button onclick="toggleKeyboard()"><h2>C Scale Keyboard lol</h2></button></div>
        <div class="row">
        <div class="row" style="display: none;">
            <div class="column2">
            </div>
            <div class="column2">
            </div>
            <div class="column1" id="C#3" style="background-color:#ccc;">
            </div>
            <div class="column2">
            </div>
            <div class="column1" id="D#3" style="background-color:#ccc;">
            </div>
            <div class="column2">
            </div>
            <div class="column2">
            </div>
            <div class="column2">
            </div>
            <div class="column2">
            </div>
            <div class="column2">
            </div>
            <div class="column1" id="F#3" style="background-color:#ccc;">
            </div>
            <div class="column2">
            </div>
            <div class="column1" id="G#3" style="background-color:#ccc;">
            </div>
            <div class="column2">
            </div>
            <div class="column1" id="A#3" style="background-color:#ccc;">
            </div>
            <div class="column2">
            </div>
            <div class="column2">
            </div>
            <div class="column2">
            </div>
            <div class="column2">                 
            </div>
            <div class="column1" id="C#4" style="background-color:#ccc;">
            </div>
            <div class="column2">
            </div>
            <div class="column1" id="D#4" style="background-color:#ccc;">
            </div>
            <div class="column2">
            </div>
            <div class="column2">
            </div>
            <div class="column2">
            </div>
            <div class="column2">
            </div>
            <div class="column1" id="F#4" style="background-color:#ccc;">
            </div>
            <div class="column2">
            </div>
            <div class="column1" id="G#4" style="background-color:#ccc;">
            </div>
            <div class="column2">
            </div>
            <div class="column1" id="A#4" style="background-color:#ccc;">
            </div>
            <div class="column2">
            </div>
            <div class="column2">
            </div>
            <div class="column2">
            </div>
            <div class="column2">
            </div>
            <div class="column2"> hi
            </div>
            <div class="column2"> hi
            </div>
            <div class="column2"> hi
            </div>
            <hr>
            
        </div>
        </div>
        <div class="row" id="keyboard" style="display: none">
            
            <div class="row">
                <div class="column" id="C3" style="background-color:#ccc;">
                </div>
                <div class="column" id="D3" style="background-color:#ccc;">
                </div>
                <div class="column" id="E3" style="background-color:#ccc;">
                </div>
                <div class="column" id="F3" style="background-color:#ccc;">
                </div>
                <div class="column" id="G3" style="background-color:#ccc;">
                </div>
                <div class="column" id="A3" style="background-color:#ccc;">
                </div>
                <div class="column" id="B3" style="background-color:#ccc;">
                </div>
                <div class="column" id="C4" style="background-color:#ccc;">
                </div>
                <div class="column" id="D4" style="background-color:#ccc;">
                </div>
                <div class="column" id="E4" style="background-color:#ccc;">
                </div>
                <div class="column" id="F4" style="background-color:#ccc;">
                </div>
                <div class="column" id="G4" style="background-color:#ccc;">
                </div>
                <div class="column" id="A4" style="background-color:#ccc;">
                </div>
                <div class="column" id="B4" style="background-color:#ccc;">
                </div>
                <div class="column" id="C5" style="background-color:#ccc;">                 
                </div>
            </div>

        </div>
        
        
    </div>
    
    <div class="row" style="padding-top: 30px;" id="audioWrapper">
        <!-- <div class="row"><input type="checkbox"  oninput="toggleOutput(this.checked)"></div> -->
        
        <div class="row">
            <select id="trackName">
                <option value="harryFalling.mp3">Harry Styles - Falling</option>
                <option value="thatsus.mp3">Anson Seabra - That's Us</option>
                <option value="wonderful.m4a">Dhruva Panyam - Wonderful World</option>
                <option value="perfect.mp3">Ed Sheeran - Perfect</option>
                <option value="allofme.mp3">John Legend - All Of Me</option>
                <option value="adele.mp3">Adele - Someone Like You</option>
                <option value="apocalypse.mp3">Cigarettes after Sex - Apocalypse</option>
                <option value="stayFull.mp3">Rihanna - Stay</option>
                <option value="stay.mp3">Rihanna - Stay (Kar)</option>
                <option value="realFriends.mp3">Camila Cabello - Real Friends</option>
                <option value="kodaline.m4a">Kodaline - All I Want</option>
                <option value="gravity.mp3">John Mayer - Gravity</option>
                <option value="yours.mp3">Jason Mraz - I'm Yours</option>
                <option value="noWay.m4a">Fifth Harmony - No Way</option>
                <option value="perfect.mp3">Ed Sheeran - Perfect</option>
                <option value="allofme.mp3">John Legend - All Of Me</option>
                <option value="dpan.mp3">When I Was Your Man</option>
                <option value="stars.mp3">Stars</option>
                <option value="run.mp3">Run</option>
                <option value="adele.mp3">Adele - Someone Like You</option>
                <option value="apocalypse.mp3">Cigarettes after Sex - Apocalypse</option>
                <option value="stayFull.mp3">Rihanna - Stay</option>
                <option value="stay.mp3">Rihanna - Stay (Kar)</option>
                <option value="harryFalling.mp3">Harry Styles - Falling</option>
                <option value="falling.mp3">Falling</option>
                <option value="emajor.mp3">E Major</option>
                <option value="stay.m4a">Sam Smith - Stay With Me</option>
                <option value="realFriends.mp3">Camila Cabello - Real Friends</option>
                <option value="kodaline.m4a">Kodaline - All I Want</option>
                <option value="voiceNoteC4.wav">Me singing C4</option>
                
            </select>
            <input type="button" value="Load" onclick="loadTrack()">
            <input id="enterName">
            <input type="button" value="Search" onclick="loadTrack(1)">
        </div>


        <div class="row">
            <div style="display:inline-block; margin: 1rem;">
                <audio id="audioFile" controls></audio>
            </div>
                
                <div style="display: inline-block ; width: 100%;">
                    <div style="width: 10%; display: inline-block;">
                    <p><b>VOLUME: </b>
                        <span style="float: right;" id='volume'>1.0 dB</span>
                        </div>
                        &nbsp;&nbsp;
                        <input style="width: 10%;" type="range" min=0 max=6 value=1 step=0.001 oninput="outputGain(this.value)">
                        <!-- <span id='seekEnd'>-:-- </span> -->
                    </p>
                </div>
                <div style="display: inline-block ; width: 100%;">
                    <p style="font-size: 50px;" id="loadedTrack"></p>
                </div>
                <div style="display: inline-block ; width: 100%;">
                    <div style="width: 10%; display: inline-block;">
                    <p><b> SEEK: </b>
                        <span style="float: right;" id='seek'>0:00 </span>
                        </div>
                        &nbsp;&nbsp;
                        <input id="seekBar" style="width: 70%; " type="range" min=0 max=120 value=0 oninput="seekTime(this.value)">
                        <span id='seekEnd'>-:-- </span>
                    </p>
                </div>
        </div>
        <div class="row"  style="padding-top: 30px;"><h1>Audio Effects</h1></div>   
        <div class="row">
                <div style="display: inline-block ; width: 100%;">
                    <div style="width: 10%; display: inline-block;">
                    <p><b> FILTER UP: </b>
                        <span style="float: right;" id='lowpass'>0 Hz</span>
                    </div>
                        &nbsp;&nbsp;
                        <input style="width: 70%; " type="range" min=0 max=10000 value=0 oninput="highFilterTrack(this.value)">
                        
                    </p>
                </div>
                <div style="display: inline-block ; width: 100%;">
                    <div style="width: 10%; display: inline-block;">
                    <p><b> FILTER DOWN: </b>
                        <span style="float: right;" id='highpass'>10000 Hz </span>
                    </div>
                        &nbsp;&nbsp;
                        <input style="width: 70%;" type="range" min=0 max=10000 value=10000 oninput="lowFilterTrack(this.value)">
                        <!-- <span id='seekEnd'>-:-- </span> -->
                    </p>
                </div>
                <div style="display: inline-block ; width: 100%;">
                    <div style="width: 10%; display: inline-block;">
                    <p><b> GAIN: </b>
                        <span style="float: right;" id='gain'>1.0 dB</span>
                    </div>
                        &nbsp;&nbsp;
                        <input style="width: 70%;" id="trackGain" type="range" min=0 max=6 value=1 step=0.001 oninput="trackGain(this.value)">
                        <!-- <span id='seekEnd'>-:-- </span> -->
                    </p>
                </div>
                <div style="display: inline-block ; width: 100%;">
                    <div style="width: 10%; display: inline-block;">
                    <p><b> MIC GAIN: </b>
                        <span style="float: right;" id='micGain'>1.0 dB</span>
                    </div>
                        &nbsp;&nbsp;
                        <input style="width: 70%;" type="range" id="trackGainMic" min=0 max=6 value=1 step=0.001 oninput="trackGainMic(this.value)">
                        <!-- <span id='seekEnd'>-:-- </span> -->
                    </p>
                </div>
                
            </div>
            <!-- <div class="row">
                <div style="display: inline-block;"><h3>CHORD: <p id="detectedNote" style="font-size: 100px;"></p></h3></div>
                
            </div>
            <div class="row"><p id="detectedScale" style="font-size: 40px; display: none;"></h3></div>
            <div class="row"><h3><p id="temp2" style="font-size: 40px;"></p></h3></div> -->

    </div>
    <div><p style="font-size: 10px;" id="second"></p></div>
    <div><p style="font-size: 60px;" id="display0"></p></div>
    <div><p style="font-size: 60px;" id="display1"></p></div>
    <div><p style="font-size: 60px;" id="display2"></p></div>
    <div><p style="font-size: 60px;" id="display3"></p></div>
    <div><p style="font-size: 60px;" id="display4"></p></div>
    <div><p style="font-size: 50px;" id="display5"></p></div>

    <div>
        <div style="display: inline-block ; width: 100%;">
            <div style="width: 5%; display: inline-block;">
                <p><b>Limit-1: </b>
                    <span style="float: right;" id='threshold0'> </span>
                    </div>
                    &nbsp;&nbsp;
                    <input style="width: 13%;" id="limit0" type="range" min=-95 max=-5 step=1 oninput="changeThreshold(0,this.value)">
                    <!-- <span id='seekEnd'>-:-- </span> -->
                &nbsp;&nbsp;
            <div style="width: 5%; display: inline-block;">
                <b>Limit-2: </b>
                    <span style="float: right;" id='threshold1'> </span>
                    </div>
                    &nbsp;&nbsp;
                    <input style="width: 13%;" id="limit1" type="range" min=-95 max=-5 step=1 oninput="changeThreshold(1,this.value)">
                    <!-- <span id='seekEnd'>-:-- </span> -->
            &nbsp;&nbsp;
            <div style="width: 5%; display: inline-block;">
                <b>Limit-3: </b>
                    <span style="float: right;" id='threshold2'> </span>
                    </div>
                    &nbsp;&nbsp;
                    <input style="width: 13%;" id="limit2" type="range" min=-95 max=-5 step=1 oninput="changeThreshold(2,this.value)">
                    <!-- <span id='seekEnd'>-:-- </span> -->
                    &nbsp;&nbsp;
            <div style="width: 5%; display: inline-block;">
                <b>Limit-4: </b>
                    <span style="float: right;" id='threshold3'> </span>
                    </div>
                    &nbsp;&nbsp;
                    <input style="width: 13%;" id="limit3" type="range" min=-95 max=-5 step=1 oninput="changeThreshold(3,this.value)">
                    <!-- <span id='seekEnd'>-:-- </span> -->
                    &nbsp;&nbsp;
            <div style="width: 5%; display: inline-block;">
                <b>Limit-5: </b>
                    <span style="float: right;" id='threshold4'> </span>
                    </div>
                    &nbsp;&nbsp;
                    <input style="width: 13%;" id="limit4" type="range" min=-95 max=-5 step=1 oninput="changeThreshold(4,this.value)">
                    <!-- <span id='seekEnd'>-:-- </span> -->
                </p>
        </div>



        <div style="display: inline-block ; width: 100%;">
            <div style="width: 5%; display: inline-block;">
                <p><b>Start-1: </b>
                    <span style="float: right;" id='stripStart0'> </span>
                    </div>
                    &nbsp;&nbsp;
                    <input style="width: 13%;" id="start0" type="range" step=1 oninput="changeStripRegion(0,0,this.value)">
                    <!-- <span id='seekEnd'>-:-- </span> -->
                &nbsp;&nbsp;
            <div style="width: 5%; display: inline-block;">
                <p><b>Start-2: </b>
                    <span style="float: right;" id='stripStart1'> </span>
                    </div>
                    &nbsp;&nbsp;
                    <input style="width: 13%;" id="start1" type="range" step=1 oninput="changeStripRegion(1,0,this.value)">
                    <!-- <span id='seekEnd'>-:-- </span> -->
                &nbsp;&nbsp;
            <div style="width: 5%; display: inline-block;">
                <p><b>Start-3: </b>
                    <span style="float: right;" id='stripStart2'> </span>
                    </div>
                    &nbsp;&nbsp;
                    <input style="width: 13%;" id="start2" type="range" step=1 oninput="changeStripRegion(2,0,this.value)">
                    <!-- <span id='seekEnd'>-:-- </span> -->
                &nbsp;&nbsp;
            <div style="width: 5%; display: inline-block;">
                <p><b>Start-4: </b>
                    <span style="float: right;" id='stripStart3'> </span>
                    </div>
                    &nbsp;&nbsp;
                    <input style="width: 13%;" id="start3" type="range" step=1 oninput="changeStripRegion(3,0,this.value)">
                    <!-- <span id='seekEnd'>-:-- </span> -->
                &nbsp;&nbsp;
            <div style="width: 5%; display: inline-block;">
                <p><b>Start-5: </b>
                    <span style="float: right;" id='stripStart4'> </span>
                    </div>
                    &nbsp;&nbsp;
                    <input style="width: 13%;" id="start4" type="range" step=1 oninput="changeStripRegion(4,0,this.value)">
                    <!-- <span id='seekEnd'>-:-- </span> -->
                &nbsp;&nbsp;
            </p>
        </div>


        <div style="display: inline-block ; width: 100%;">
            <div style="width: 5%; display: inline-block;">
                <p><b>End-1: </b>
                    <span style="float: right;" id='stripEnd0'> </span>
                    </div>
                    &nbsp;&nbsp;
                    <input style="width: 13%;" id="end0" type="range" step=1 oninput="changeStripRegion(0,1,this.value)">
                    <!-- <span id='seekEnd'>-:-- </span> -->
                &nbsp;&nbsp;
            <div style="width: 5%; display: inline-block;">
                <p><b>End-2: </b>
                    <span style="float: right;" id='stripEnd1'> </span>
                    </div>
                    &nbsp;&nbsp;
                    <input style="width: 13%;" id="end1" type="range" step=1 oninput="changeStripRegion(1,1,this.value)">
                    <!-- <span id='seekEnd'>-:-- </span> -->
                &nbsp;&nbsp;
            <div style="width: 5%; display: inline-block;">
                <p><b>End-3: </b>
                    <span style="float: right;" id='stripEnd2'> </span>
                    </div>
                    &nbsp;&nbsp;
                    <input style="width: 13%;" id="end2" type="range" step=1 oninput="changeStripRegion(2,1,this.value)">
                    <!-- <span id='seekEnd'>-:-- </span> -->
                &nbsp;&nbsp;
            <div style="width: 5%; display: inline-block;">
                <p><b>End-4: </b>
                    <span style="float: right;" id='stripEnd3'> </span>
                    </div>
                    &nbsp;&nbsp;
                    <input style="width: 13%;" id="end3" type="range" step=1 oninput="changeStripRegion(3,1,this.value)">
                    <!-- <span id='seekEnd'>-:-- </span> -->
                &nbsp;&nbsp;
            <div style="width: 5%; display: inline-block;">
                <p><b>End-5: </b>
                    <span style="float: right;" id='stripEnd4'> </span>
                    </div>
                    &nbsp;&nbsp;
                    <input style="width: 13%;" id="end4" type="range" step=1 oninput="changeStripRegion(4,1,this.value)">
                    <!-- <span id='seekEnd'>-:-- </span> -->
                &nbsp;&nbsp;
            </p>
        </div>
        
        
    </div>
    <input type="checkbox" checked onchange="toggleGraphDisplay(this.checked)">
    <label>Show Graph?</label><br>

    <div id="chartContainer" style="width: 100%; height: 400px;"></div>
    
    
</body>
</html>



<script src="./js/methods.js"></script>
<script src="./js/testing.js"></script>

<script src="./js/tone.js"></script>



<script>
    
//---------------------------------------------------APP MODE------------------------------------------------

const out = ['','chord']
let output=out[1]

function toggleOutput(val){
    if(val==false)
        output = ''
    else
        output = 'chord'
}

//---------------------------------------------------RECORDER------------------------------------------------

const audioFile = document.querySelector('audio');
const actx = Tone.context;
const dest = actx.createMediaStreamDestination()
const recorder = new MediaRecorder(dest.stream)

var chunks = []

// recorder.ondataavailable = evt => chunks.push(evt.data)
// recorder.onstop = evt => {
//     let blob = new Blob(chunks, {type: 'audio/ogg; codecs=opus'})
//     audioFile.src = URL.createObjectURL(blob)
// }



//---------------------------------------------------SYNTH-PIANO------------------------------------------------

var synth = new Tone.PolySynth(6, Tone.Synth, {
  oscillator : {
		type : "triangle"
    },
})
synthALX = new Tone.Analyser("fft",16384).toMaster()
synth.connect(synthALX)
synth.volume.value = -7
synth.set({
    "envelope":{
        "release":1
    },
    "filter":{
        "type":"highpass"
    }
})


var sampler = new Tone.Sampler({
    "C4":'./synth/C4v60.wav'
},{
    release: 5,
    attack: 0,
    sustain: 5
    // curve: 'exponential'
})

// sampler.sync()

var samplerGain = new Tone.Gain().toMaster()
sampler.connect(samplerGain)
samplerGain.gain.value = 0.4

// document.getElementById('testingMidi').addEventListener('onclick',function(event){
//     console.log('hello')
// })

function attackC4(){
    sampler.triggerAttack('C4')
}

function releaseC4(){
    sampler.triggerRelease('C4')
}



//---------------------------------------------------SONG PLAYER----------------------------------------

var track = "./songs/gravity.mp3"
var songPlayer = new Tone.Player(track)
// console.log(songPlayer)

var filterLowerBound = new Tone.Filter()
filterLowerBound.type="highpass"
filterLowerBound.frequency.value = 0

var filterUpperBound = new Tone.Filter()
filterUpperBound.type="lowpass"
filterUpperBound.frequency.value = 10000

songPlayer.connect(filterLowerBound)
songPlayer.connect(filterUpperBound)
songPlayer.sync()

songPlayerGain = new Tone.Gain()
songPlayerALX = new Tone.Analyser("fft",16384)

filterLowerBound.connect(songPlayerGain)
filterUpperBound.connect(songPlayerGain)

songPlayerGain.connect(songPlayerALX)                            // CHANGED FOR MIC
songPlayerVolume = new Tone.Gain().toMaster()
songPlayerVolume.gain.value = 0.5
filterLowerBound.connect(songPlayerVolume)
filterUpperBound.connect(songPlayerVolume)

songPlayerVolume.connect(dest)                                  // Record to audio file


// console.log(filterLowerBound)
// console.log(songPlayerGain)



let dur;
dur = dur = songPlayer.buffer.duration
document.getElementById('seekBar').max=dur
document.getElementById('seekBar').value=0
displaySeek(dur,'seekEnd')

function loadTrack(a=0){
    for(i=0;i<12;i++)
        KEYS[i][1]=0
    if(a) trackName = document.getElementById('enterName')
    else trackName = document.getElementById('trackName')
    console.log('loaded',trackName.value)
    songPlayer.load('./songs/'+trackName.value,function(){

        options = trackName.getElementsByTagName('option');

        for(var i=0;i<options.length;i++){
            // console.log(options[i])
            if(options[i].value==trackName.value)
                if(a==0) document.getElementById('loadedTrack').innerHTML = options[i].innerHTML
                else document.getElementById('loadedTrack').innerHTML = trackName
        }

        dur = songPlayer.buffer.duration
        // console.log(dur)
        document.getElementById('seekBar').max=dur
        document.getElementById('seekBar').value=0
        displaySeek(dur,'seekEnd')
    })
    Tone.Transport.stop()
}
// loadTrack('gravity.mp3')

function highFilterTrack(val){
    filterLowerBound.frequency.value=val
    document.getElementById('lowpass').innerHTML=' '+String(val)+' Hz'
}
function lowFilterTrack(val){
    filterUpperBound.frequency.value=val
    document.getElementById('highpass').innerHTML=' '+String(val)+' Hz'
}

function trackGain(val){
    songPlayerGain.gain.value=val
    // console.log(val)
    document.getElementById('gain').innerHTML=' '+String(val)+' dB'
}

function outputGain(val){
    songPlayerVolume.gain.value=val
    document.getElementById('volume').innerHTML=' '+String(val)+' dB'
}



//---------------------------------------------------MIC UP----------------------------------------------

var mic = new Tone.UserMedia()
var micALX = new Tone.Analyser("fft",16384)//.toMaster()
mic.connect(filterLowerBound)
filterLowerBound.connect(filterUpperBound)
// mic.connect(micGain)
// micGain.connect(micALX)
var micGain = new Tone.Gain()
filterUpperBound.connect(micGain)
micGain.connect(micALX)

function trackGainMic(val){
    micGain.gain.value = val
    document.getElementById('micGain').innerHTML = val+'dB'
}

mic.connect(micALX);


//----------------------------------------------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------------------------------------------
//------------------------------------------------------------CONSTS----------------------------------------------------------------------------------------------

const ACC = 100, AVG = 100
let COUNT = 0

const notes = {
    24:'C1',26:'C#1',27:'D1',29:'D#1',31:'E1',32:'F1',34:'F#1',36:'G1',39:'G#1',41:'A1',43:'A#1',46:'B1',
    49:'C2',51:'C#2',55:'D2',58:'D#2',61:'E2',65:'F2',69:'F#2',73:'G2',77:'G#2',82:'A2',87:'A#2',92:'B2',
    97:'C3',103:'C#3',109:'D3',114:'D#3',122:'E3',130:'F3',137:'F#3',146:'G3',154:'G#3',163:'A3',173:'A#3',183:'B3',
    194:'C4',206:'C#4',218:'D4',231:'D#4',245:'E4',259:'F4',275:'F#4',291:'G4',309:'G#4',327:'A4',346:'A#4',367:'B4',
    389:'C5',412:'C#5',436:'D5',462:'D#5',490:'E5',519:'F5',550:'F#5',583:'G5',617:'G#5',654:'A5',693:'A#5',734:'B5'
}

// console.log(notes[179])


const scale = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B']
const revScale = {'C':0,'C#':1,'D':2,'D#':3,'E':4,'F':5,'F#':6,'G':7,'G#':8,'A':9,'A#':10,'B':11}

const tension = {                   //equals amount of energy released if paired with BASE
    0:20,           //MAX
    1:13,
    2:5,
    3:16.5,
    4:18,
    5:16,
    6:1,
    7:19,
    8:15,
    9:17.5,
    10:8,
    11:8
}

let prevChord = null

let averages = []
for(var i=0;i<AVG;i++)  averages[i] = []

let chordRecord = []
for(var i=0;i<700;i++)  chordRecord[i] = []


const majorScale = {1:1,10:1,3:1,6:1}    // NOTES NOT IN A MAJOR SCALE                NO ACCIDENTALS

let brownie = [0,0]
let lockBrownie = 0

var past = []
const lim = 150

//------------------------------------------------------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------TONE.TRANSPORT---------------------------------------------------------------------------

// Tone.Transport.loop=true
Tone.Transport.setLoopPoints(10,100)

Tone.volume = -10
Tone.start('+0.2s')

function seekTime(val){
    Tone.Transport.seconds = val;
    displaySeek(val)
}


Tone.Transport.scheduleRepeat(function(time){
    displaySeek(Tone.Transport.seconds)
    // lockBrownie=0
    COUNT+=1
    // var fft = songPlayerALX.getValue();
    
    // repeatApp(fft); //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
     
    
},'0.005')

//-----------------------------------------------------------------------------------------CANVAS-------------------------------------------------------------------------------------------------------------


var threshold = [-60,-55,-50,-45,-40]
var octaveRegions1 = 
[
    {start:20,end:60},
    {start:47,end:94},
    {start:94,end:188},
    {start:188,end:378},
    {start:378,end:740},
]
var octaveRegions = octaveRegions1
// [
//     {start:20,end:60},
//     {start:38,end:111},
//     {start:80,end:220},
//     {start:165,end:350},
//     {start:330,end:400},
// ]

for(t in threshold){
    document.getElementById('threshold'+String(t)).innerHTML = threshold[t]
    document.getElementById('limit'+String(t)).value = threshold[t]
}

for(i in octaveRegions){
    o = parseInt(i)
    // console.log(document.getElementById('stripStart'+String(o)))
    document.getElementById('stripStart'+String(o)).innerHTML = octaveRegions[o].start
    document.getElementById('stripEnd'+String(o)).innerHTML = octaveRegions[o].end

    s = document.getElementById('start'+String(o))
    s.value = octaveRegions[o].start
    if(o==0)
        s.min = octaveRegions[0].start
    else
        s.min = Math.floor((octaveRegions1[o-1].end + octaveRegions1[o-1].start)/2)
    
    if(o==4)
        s.max = octaveRegions[4].end
    else
        s.max = octaveRegions1[o+1].start
    
    e = document.getElementById('end'+String(o))
    e.value = octaveRegions[o].end
    if(o==0)
        e.min = octaveRegions[0].start
    else
        e.min = octaveRegions1[o-1].end
    
    if(o==4)
        e.max = octaveRegions[4].end
    else
        e.max = Math.floor((octaveRegions1[o+1].end + octaveRegions1[o+1].start)/2)
    
}

var dps = []

for(var i=0;i<octaveRegions[4].end;i++){
    // console.log(i,i in notes)
    dps.push({x:i,y:-95})
}
// dps.push({x:160,y:-95})

// console.log(dps)

var chart = new CanvasJS.Chart("chartContainer",{
    title :{
        text: "Audio FFT"
    },
    axisX: {						
        title: "Frequency",
        stripLines:[                    // FOR EACH OCTAVE
        {
            startValue: octaveRegions[0].start,             // OCTAVE 1
            endValue: octaveRegions[0].end,
            color:"#8cbec2",
            opacity:0.9
        },
        {
            startValue: octaveRegions[1].start,             // OCTAVE 2
            endValue: octaveRegions[1].end,
            color:"#ffd480",
            opacity:0.9
        },
        {
            startValue: octaveRegions[2].start,             // OCTAVE 3
            endValue: octaveRegions[2].end,
            color:"#f08d86",
            opacity:0.9
        },
        {
            startValue: octaveRegions[3].start,             // OCTAVE 4
            endValue: octaveRegions[3].end,
            color:"#a1de90",
            opacity:0.9
        },
        {
            startValue: octaveRegions[4].start,             // OCTAVE 5
            endValue: octaveRegions[4].end,
            color:"#b5b5ba",
            opacity:0.9
        }
        ]
    },
    axisY: {						
        title: "Strength",
        // stripLines:[
        //     {
        //         value: threshold[0],
        //         color:"red",
        //         thickness:2,
        //         opacity: 0.7

        //     },
        //     {
        //         value: threshold[1],
        //         color:"red",
        //         thickness:2,
        //         opacity: 0.7

        //     },
        //     {
        //         value: threshold[2],
        //         color:"red",
        //         thickness:2,
        //         opacity: 0.7

        //     },
        //     {
        //         value: threshold[3],
        //         color:"red",
        //         thickness:2,
        //         opacity: 0.7

        //     },
        //     {
        //         value: threshold[4],
        //         color:"red",
        //         thickness:2,
        //         opacity: 0.7

        //     }
        // ]
    },
    data: [{
        type: "line",
        dataPoints : dps
    }]
});

chart.render();
var DISPLAY_GRAPH = true
function toggleGraphDisplay(val){
    DISPLAY_GRAPH = val
}
var updateInterval = 0.1;


OUTPUT_TYPE = 'note'
second =document.getElementById('second')


var intervals = 1

//-----------------------------------------------------------------------------METHODS------------------------------------------------------------------------------

function changeThreshold(octave,val){
    // console.log('threshold is',B_THRESHOLD)
    threshold[octave] = parseInt(val)
    
    document.getElementById('threshold'+String(octave)).innerHTML = threshold[octave]

    // chart.axisY[0].stripLines[octave].set('value',Math.floor(threshold[octave]))
}

function changeStripRegion(octave,endPoint,val){
    if(endPoint==0) // start
    {
        octaveRegions[octave].start = parseInt(val)
        document.getElementById('stripStart'+String(octave)).innerHTML = octaveRegions[octave].start
    
        chart.axisX[0].stripLines[octave].set('startValue',(octaveRegions[octave].start))

        if(octave==0)
            p = 0
        else
            p = octaveRegions[octave-1].end
        for(;p<parseInt(val);p++)
            dps[p]['y']=-95;
    }

    else
    {
        octaveRegions[octave].end = parseInt(val)
        document.getElementById('stripEnd'+String(octave)).innerHTML = octaveRegions[octave].end
    
        chart.axisX[0].stripLines[octave].set('endValue',(octaveRegions[octave].end))

        if(octave==4)
            p = octaveRegions[4].end
        else
            p = octaveRegions[octave+1].start
        for(;p>parseInt(val);p--)
            dps[p]['y']=-95;
    }
}

// ---------------------------------------------------------------------------------------------------------------
//-----------------------UPDATE FUNCTION------------------------------------------------

let hist = []
histLength = 50
for(var i=0;i<histLength;i++){
    hist.push(null)
}

chordHist = []
for(var i=0;i<25;i++)
    chordHist.push(null)

avgBass = -70
avgMid = -60
avgHigh = -40

peakLimit = [
    {low:1,high:2},
    {low:1,high:2},
    {low:2,high:4},
    {low:2,high:4},
    {low:2,high:5}
]

thresholdLimit = [-60,-55,-50,-50,-45]

PREVCHORD = null
PREVNOTE = {note:null,octave:null}
NOTECOUNT = 0
currentNoteCount = 0
NOTES_RECORDING = []


PREVCLUSTER = new Set()
playAlong = false
function togglePlayAlong(val){
    // console.log(val)
    playAlong = val

    if (!playAlong)
        synth.releaseAll()
}

PREVCOUNT = 0
chordGroup = {}

KEYS = [[0,0],[1,0],[2,0],[3,0],[4,0],[5,0],[6,0],[7,0],[8,0],[9,0],[10,0],[11,0]]

/////////////////
inputDetails = {
    'mic':{
        input: 'mic',
        gain: micGain,
        alx: micALX, 
        trackGain: trackGainMic
        , DOM: 'trackGainMic'
    },
    'file':{
        input:'file',
        gain: songPlayerGain,
        alx: songPlayerALX, 
        trackGain: trackGain, 
        DOM: 'trackGain'
    }
}
currentAnalysis = inputDetails['file']
songPlayer.start(0)

function changeInput(type){

    if(currentAnalysis.input != type)
    {
        currentAnalysis = inputDetails[type]
        if(type=='mic'){
            d = new Date()
            TIME_STARTED = d.getTime()

            Tone.Transport.pause()
            mic.open()
        }
        else{
            Tone.Transport.start()        
            mic.close()
        }
    }
}


// currentAnalysis = {}



/////////////////

//-------------------------------------------DEFINITION-----------------------------------------------------

var alxChord = function(){
    if(Tone.Transport.state!='started' && currentAnalysis.input=='file') {
        synth.releaseAll()
        // console.log('bye')
        return
    }

    intervals++;

    
    if(DISPLAY_GRAPH) chart.render()

    IDEA = 2    

    AVERAGE_VOLUME = 0
    for(var i=0;i<4;i++){
        AVERAGE_VOLUME += threshold[i]
    }
    AVERAGE_VOLUME = Math.floor(AVERAGE_VOLUME/4)

    // document.getElementById('display0').innerHTML = AVERAGE_VOLUME


    //------------------------------------EDIT VOLUME IF TOO SOFT OR LOUD-------------------------------

    if(AVERAGE_VOLUME < -50 && currentAnalysis.gain.gain.value <= 5.5){
        currentAnalysis.trackGain(currentAnalysis.gain.gain.value + 0.01)
        document.getElementById(currentAnalysis.DOM).value = currentAnalysis.gain.gain.value
    }
    if(AVERAGE_VOLUME > -35 && currentAnalysis.gain.gain.value >0.2){
        currentAnalysis.trackGain(currentAnalysis.gain.gain.value - 0.01)
        document.getElementById(currentAnalysis.DOM).value = currentAnalysis.gain.gain.value
    }

    //--------------------------------------------------------------------------------------------------
    
    var tops = [[],[],[],[],[]] // Loudest notes found in the 5 octaves
    // console.log(currentAnalysis.input == 'mic')
    if(currentAnalysis.input=='mic')
        alx = micALX.getValue(); // Frequency graph
    else
        alx = songPlayerALX.getValue();

    for(var oct=0;oct<5;oct++){

        for(let p=octaveRegions[oct].start;p<octaveRegions[oct].end;p++){

            if(parseInt(p)==dps.length-1) continue      // need this to keep the graph stable (visually)
            
            x = dps[p]["x"]             // index of frequency
            if(alx[x]<=-95) continue    // if too soft, don't care about it
                
            dps[p]["y"] = alx[x]        // update value if loud enough
            
            if(IDEA==1)
                check = -45
            if(IDEA==2)
                check = threshold[oct]  // To add it to the top frequencies, the strength must be greater than the dynamic threshold of the octave

            if(alx[x]>check && (x in notes || OUTPUT_TYPE=='note')){         // If the frequency is a note,     
                if(OUTPUT_TYPE=='chord') {
                    tops[oct].push([notes[x],alx[x]])   // Add it to the top-list
                    dps[p]["indexLabel"] = notes[x]     
                }
                else {
                    closest = findClosestNote(x)
                    if(closest==null) continue
                    tops[oct].push([closest[1],alx[x]])
                    if(x in notes)
                        dps[p]["indexLabel"] = notes[x]     
                    else
                        dps[p]["indexLabel"] = ''   
                }
                
            }
            else
                dps[p]["indexLabel"] = ''
        }

        //---------------------------DYNAMIC THRESHOLDS---------------------------------------------
                // change the threshold of an octave if there are too many peaks, or too few.

        if(IDEA==2){

            if(tops[oct].length > peakLimit[oct].high && threshold[oct] < -25){     // If the number of peaks is greater than the limit specified, and the threshold is still below -25
                
                total = 0
                for(var i=0;i<tops[oct].length;i++)
                    total+=tops[oct][i][1]
                
                avg = Math.floor(total/tops[oct].length)                    // Gets average strength of all peaks
                tops[oct] = tops[oct].filter(x=>{return x[1] > avg+8})      // Keeps only the peaks that have strength > (avg+8)-------8 can be changed--------meant for drums, etc.

                
                changeThreshold(oct,threshold[oct]+1);                      // INCREASE threshold by 1
                document.getElementById('limit'+String(o)).value=threshold[oct]+1
            }

            if(tops[oct].length < peakLimit[oct].low && threshold[oct] > thresholdLimit[oct]){// If the number of peaks is smaller than the limit specified, and the threshold is still above the lower limit
                changeThreshold(oct,threshold[oct]-1);                      // DECREASE threshold by 1
                document.getElementById('limit'+String(oct)).value=threshold[oct]-1
            }
        }
        //--------------------------------------------------------------------------------------------------
    }

    // 2 IDEAS : 
    // 1 - don't change thresholds, and find peaks. If there are too many peaks, filter out peaks of peaks, and only if the slope of the peak is steep enough (lol didn't work)
    // 2 - change thresholds and trust it to return the right peaks

    
    
    
    
    if(IDEA==2){
        
        // -----------------------------------------GENERATE PEAKS--------------------------------------------------------

        results = tops.map(x=>{
            return decluster(x)             // Finds all the "significant" peaks in clustered frequencies of 'tops'
        })

        for(var i=0;i<5;i++){
            // if(results[i].length) 
            //     document.getElementById('display'+String(i)).innerHTML = results[i].map(x=>x[0])          // Display peak notes
            // else document.getElementById('display'+String(i)).innerHTML = '-'
        }

        for(var i=0;i<5;i++){
            results[i] = results[i].sort((a,b)=>{b[1]-a[1]})        // Sort all the peaks of an octave by decreasing strengths
            // if(results[i].length) 
                // document.getElementById('display'+String(i)).innerHTML += Math.floor(results[i][0][1])
        }

        results = results.filter(x=>{return x.length>0})        // Consider only the octaves which have significant peaks
        // console.log(results)

        if(results.length==0) return

        // ---------------------------------------------------------------------------------------------------------------
        // ---------------------------------------------------------------------------------------------------------------
        if(OUTPUT_TYPE=='note'){
            notesSet = {}
            for(var i=0;results[i];i++){
                for(var j=0;results[i][j];j++)
                    if(results[i][j][0][results[i][j][0].length-1]!='1') {
                        note = results[i][j][0].substring(0,results[i][j][0].length-1)
                        if(note in notesSet)
                        {
                            notesSet[note].count++;
                            notesSet[note].octaveStrength += (parseInt(results[i][j][0][results[i][j][0].length-1]));
                            notesSet[note].strength += results[i][j][1]
                            
                        }
                        else
                        {
                            notesSet[note] = {
                                count: 1,
                                strength: results[i][j][1],
                                octaveStrength: (parseInt(results[i][j][0][results[i][j][0].length-1])),
                                octave: parseInt(results[i][j][0][results[i][j][0].length-1])
                            }
                        }
                    }
            }

            if(Object.keys(notesSet).length==0) return

            NOTE = {note:null,strength:0,octave:0}
            for(note in notesSet){
                // console.log(NOTE)
                compare = Math.abs((notesSet[note].strength * notesSet[note].octaveStrength) / Math.pow(notesSet[note].count,3))
                // if(NOTE)console.log(NOTE.strength > compare)
                if(NOTE.note==null || NOTE.strength > compare){
                    NOTE.note= note
                    NOTE.strength= compare
                    NOTE.octave = notesSet[note].octave
                }
                // console.log(note,compare)
            }
            
            // console.log(NOTE)
            if(PREVNOTE.note!=NOTE.note || PREVNOTE.octave!=NOTE.octave){
                
                d = new Date()
                t = d.getTime() - TIME_STARTED
                if(NOTES_RECORDING.length) {
                    NOTES_RECORDING[NOTES_RECORDING.length - 1].releaseTime = t
                    NOTES_RECORDING[NOTES_RECORDING.length - 1].count = currentNoteCount
                    if(NOTE.note==PREVNOTE.note) NOTES_RECORDING[NOTES_RECORDING.length - 1].octave = NOTE.octave
                }
                NOTES_RECORDING.push({note:NOTE.note,attackTime:t,octave:NOTE.octave})
                
                // document.getElementById('display5').innerHTML += PREVNOTE.octave+' ('+String(currentNoteCount)+')'+'<br>'
                document.getElementById('display5').innerHTML += NOTE.note
                
                currentNoteCount = 1
                PREVNOTE.note=NOTE.note
                PREVNOTE.octave = NOTE.octave
                // NOTECOUNT++
                // if(NOTECOUNT%8==0) {document.getElementById('display5').innerHTML += '<br>';NOTECOUNT=0}
            }
            else
                currentNoteCount++;
            
            // if(intervals%90==0) document.getElementById('display5').innerHTML = ''

            // console.log(intervals)
        }
        if(OUTPUT_TYPE=='chord' && intervals%(15/updateInterval)==0){
            // ----------------------------------CHORD FINDING / SCORING SYSTEM-----------------------------------------------

            myArr = new Set()
            for(var i=0;i<results.length;i++){
                for(var j=0;j<results[i].length;j++){
                    myArr.add(results[i][j])                        // Gets all peaks in a set
                }
            }

            newdisp = document.getElementById('display5')

            CHORDS = []     // List of chords found with these results

            for(var n of myArr){    // Try making a chord with every peak note as the ROOT

                // ------------------------------------------Creating chord---------------------------------------------

                BASE = n                
                root = BASE[0].substring(0,BASE[0].length-1)

                chordP = new Set()      // Progressive notes found with this root

                weighted = []           

                for(var m of myArr){
                    m_note = m[0].substring(0,m[0].length-1)

                    temp = (12 + revScale[m_note]-revScale[root])%12        // Relative numbered note of m with respect to root

                    weighted.push([temp, m[1]])     // Add note number, weight
                    chordP.add(temp)                // Add note number
                }

                // console.log(Array(12).map(x=>null)[0]==null)
                
                // -----------------------------------------Scoring chord-----------------------------------------------    (LOWER THE SCORE, BETTER THE CHORD)

                scores = Array(12).map(x=>null)         // To combine repeated notes' strengths

                for(var i=0;i<weighted.length;i++){

                    off = weighted[i][0]    // offset number
                    vol = weighted[i][1]    // note strength

                    if(scores[off]==null){
                        scores[off] = [off, Math.abs(vol), 1]       // scores[i] = [i,-35,1]
                    }
                    else
                    {
                        scores[off][1]+=Math.abs(vol)           // add the strength
                        scores[off][2]++;                       // increase count of number
                    }
                }

                for(var i=0;i<12;i++){
                    if(scores[i]==null) continue

                    scores[i] = [i,(Math.floor((scores[i][1])/Math.pow(scores[i][2],2)))]           // Combined score for a note = (total strength) / (count)^2 ------------ = avg strength / count
                }

                // scores = scores.filter(y=>{
                //     if(y==null)
                //         return false
                //     x = y[0]
                //     if(x!=0 && x!=3 && x!=4 && x!=7 && x!=10 && x!=11)          // Keep only 0,3,4,7,10,11
                //         return false

                //     return true
                // })

                if(scores.length == 0) continue

                BASE = BASE[0]
                octave = BASE[BASE.length-1]

                // IMPORTANT: Now, we can find all the chords possible using the notes found, and push them into CHORDS

                // (make the following into a function)
                bass = root
                if(results[0][0][1] > -37 && results[0][0][0].substring(0,results[0][0][0].length-1) != BASE.substring(0,BASE.length-1)){           // If the lowest bass note is loud enough, and not the same as the root
                    bass=results[0][0][0].substring(0,results[0][0][0].length-1)
                }

                myChords = []
                if(chordP.has(0)){
                    // should do anyway
                    len = 1 // number of notes in chord
                    sum0 = scores[0][1]
                    sum = (sum0/(len*len)) * (octave * 50)
                    myChords.push({type: '',score: sum})

                    if(chordP.has(7)){
                        // found a fifth
                        len = 2
                        sum7 = sum0 + scores[7][1]
                        sum = (sum7/(len*len)) * (octave * 15)
                        myChords.push({type: '5',score: sum})

                        if(chordP.has(3)){
                            // found a minor triad
                            len = 3
                            sum3 = sum7 + scores[3][1]
                            sum = (sum3/(len*len)) * (octave * 5)
                            myChords.push({type: 'min',score: sum})

                            if(chordP.has(10)){
                                // found a m7 chord
                                len = 4
                                sum10 = sum3 + scores[10][1]
                                sum = (sum10/(len*len)) * (octave * 5)
                                myChords.push({type: 'm7',score: sum})
                            }

                            if(chordP.has(11)){
                                // found a mM7 chord
                                len = 4
                                sum11 = sum3 + scores[11][1]
                                sum = (sum11/(len*len)) * (octave * 7)
                                myChords.push({type: 'mM7',score: sum})
                            }
                        }

                        if(chordP.has(4)){
                            // found a major triad
                            len = 3
                            sum4 = sum7 + scores[4][1]
                            sum = (sum4/(len*len)) * (octave * 5)
                            myChords.push({type: 'maj',score: sum})

                            if(chordP.has(10)){
                                // found a 7 chord
                                len = 4
                                sum10 = sum4 + scores[10][1]
                                sum = (sum10/(len*len)) * (octave * 5)
                                myChords.push({type: '7',score: sum})
                            }

                            if(chordP.has(11)){
                                // found a maj7 chord
                                len = 4
                                sum11 = sum4 + scores[11][1]
                                sum = (sum11/(len*len)) * (octave * 10)
                                myChords.push({type: 'maj7',score: sum})
                            }
                        }
                    }
                }
                myChords = myChords.map(x => {
                    if(x.root == x.bass)
                        name = root+x.type
                    else
                        name = root+x.type+'/'+bass
                    return {
                        root: root,
                        type: x.type,
                        bass: bass,
                        score: x.score,
                        name: name
                    }
                })
                CHORDS = CHORDS.concat(myChords)

                // console.log(BASE[0])
                // console.log(scores)
                // sum=0
                // for(var i=0;scores[i];i++){
                //     sum+=scores[i][1]       // Add all scores of notes in chord
                // }


                // --------------------FINAL SCORE--------------------------------------------------------------------
                
                // ---------------------------------------------------------------------------------------------------


                // console.log(sum)
            
                
                // newdisp.innerHTML = ''

                // console.log(BASE,chordP)
                // BASE = BASE[0]
                
                // if(chordP.has(7)){
                //     if(chordP.has(4)){
                //         type = 'maj'
                //         if(chordP.has(10))
                //             type ='7'
                //         else if(chordP.has(11))
                //             type = 'maj7'
                //         if(results[0][0][1] > -40 && results[0][0][0].substring(0,results[0][0][0].length-1) != BASE.substring(0,BASE.length-1)){
                //             type+='/'+results[0][0][0].substring(0,results[0][0][0].length-1)
                //         }
                        
                        
                    
                //         CHORDS.push([BASE,type,sum])
                //     }
                //     if(chordP.has(3)){
                //         type = 'min'
                //         if(chordP.has(10))
                //             type ='m7'
                //         else if(chordP.has(11))
                //             type = 'mM7'
                //         if(results[0][0][1] > -40 && results[0][0][0].substring(0,results[0][0][0].length-1) != BASE.substring(0,BASE.length-1)){
                //             type+='/'+results[0][0][0].substring(0,results[0][0][0].length-1)
                //         }
                        
                        
                        
                    
                //         CHORDS.push([BASE,type,sum])
                //     }

                //     type='5'

                //     if(results[0][0][1] > -45 && results[0][0][0].substring(0,results[0][0][0].length-1) != BASE.substring(0,BASE.length-1)){
                //         type+='/'+results[0][0][0].substring(0,results[0][0][0].length-1)
                //     }
                //     CHORDS.push([BASE,type,sum])
                    
                    
                // }
            }
        

            // CHORDS.sort((a,b)=>{
            //     return (parseInt(a[0][a[0].length-1]) - parseInt(b[0][b[0].length-1]))
            // })
            
            // console.log(CHORDS)
            CHORDS.sort((a,b)=>{
                return a.score - b.score
            })

            if(CHORDS.length==0) return

            // console.log(CHORDS.filter(x=> x[1][0]!='5')) 
            // if(CHORDS.filter(x=>x[1][0]!='5').length)
            //     temp = CHORDS.filter(x=>x[1][0]!='5')[0]   
            // else
            //     temp = CHORDS[0]

            hist.unshift(CHORDS[0])
            // newdisp.innerHTML = temp

            counts = {}
            
            for(var i=0;i<histLength;i++){ 
                
                if(hist[i]==null) break
                
                x = hist[i].name
                // console.log(x)
                if(x in counts){
                    counts[x].num++
                }
                else{
                    counts[x] = {
                        num: 1,
                        chord: hist[i]
                    }
                }
            }
            // console.log(counts)

            m = null
            m2=null
            for(c in counts){
                // console.log(c)
                if(m==null || counts[c].num>counts[m].num){
                    m2 = m
                    m = c
                }
                    
            }
            // console.log(m)

            if(m==null) return

            if(m2 && counts[m2][0]<histLength/5) 
                m2=null

            // final = combine(m,m2)
            final = counts[m].chord

            root = final.root
            type = final.type
            bass = final.bass
            // console.log(type.split('/'))
            // console.log(final)
            
            if( (type=='5' || type=='') && PREVCHORD && root == PREVCHORD.root && (PREVCHORD.type[0]=='m' || PREVCHORD.type[0]=='7')){
                final = PREVCHORD
            }

            if(playAlong){
                NOTES1 = getNotes(PREVCHORD)
                // for(var n in NOTES.values())
                //     synth.triggerRelease(NOTES[i])

                
                NOTES2 = getNotes(final)

                union = new Set()
                for(var x of NOTES1) union.add(x)
                for(var x of NOTES2) union.add(x)

                // console.log(union)

                for(var x of union){
                    if(NOTES1.has(x) && NOTES2.has(x)) continue

                    if(NOTES1.has(x))
                        synth.triggerRelease(x)
                    else
                        synth.triggerAttack(x)
                }
            }

            // If both sets have some same notes, don't do anything with them
            // If note in setA but not in set B, release
            // If note in setB but not in setA, attack

            // for(var i=0;NOTES[i];i++)
            //     synth.triggerAttack(NOTES[i])
            // attackNotes(final)

            possible = findKeys(final)
            for(x of possible)
                KEYS[x][1]++;


            // final = current chord
            // PREVCHORD = previous chord

            // if current "goes with" the previous one, add it to the group
            // if not, then process the last group
            //      -> find the count for each root
            //      -> find the winning chord of the root
            //      -> display total count with winning chord

            m = null
            m2=null
            for(i=0;i<12;i++){
                if(m==null || m[1]<KEYS[i][1]){
                    // m2=m
                    m = KEYS[i]
                }
                if((m2==null || m2[1]<KEYS[i][1]) && m!=KEYS[i])
                    m2 = KEYS[i]
                
            }
            document.getElementById('display3').innerHTML = 'Most likely keys: ' + scale[m[0]] +', ' + scale[m2[0]]
            
            if(PREVCHORD && final.name==PREVCHORD.name){
                PREVCOUNT++;
                // newdisp.innerHTML += '+'
            }
            else{
                
                PREVCOUNT=1
                PREVCHORD = final
                temp = KEYS
                console.log(temp)
                // document.getElementById('display4').innerHTML = String()
                newdisp.innerHTML = PREVCHORD.name + ' '
                
            }
                

            
            
            return
        }


    }

}





setInterval(function(){alxChord()}, updateInterval);

function playNotesRecorded(){
    // Format = [{note:'C',time:181727389191,octave:'4'}]
    // updateInterval tells us the number of milliseconds per count
    
    // offset = updateInterval*500 // 0.5*100 = 50

    if(NOTES_RECORDING.length){
        d = new Date()
        t = d.getTime()
        
        NOTES_RECORDING[NOTES_RECORDING.length - 1].releaseTime = t
        NOTES_RECORDING[NOTES_RECORDING.length - 1].count = currentNoteCount
    }

    for(i=0;NOTES_RECORDING[i];i++){
        if(NOTES_RECORDING[i].count <= 10) continue
        timeToStart = (NOTES_RECORDING[i].attackTime)/1000
        console.log(timeToStart)
        
        noteToPlay = NOTES_RECORDING[i].note + NOTES_RECORDING[i].octave
        sampler.triggerAttack(noteToPlay,'+'+String(timeToStart))
        timeToEnd = (NOTES_RECORDING[i].releaseTime)/1000
        sampler.triggerRelease(noteToPlay,'+'+String(timeToEnd))
        
        
        // total+= NOTES_RECORDING[i].count
        
    }

    // sampler.triggerAttackRelease('C4')
    // sampler.triggerAttackRelease('D4','+5')

    // console.log(TIME_STARTED)
    
}

function findClosestNote(x){
    low=0
    high=0
    while(1){
        if((x-low) in notes)
            return [x-low,notes[x-low]]
        
        if((x+high) in notes)
            return [x+high,notes[x+low]]

        low--;
        high++;

        if(low<20 || high>740) break
    }
    return null
}

// scaleNotes = new Set([3,6,10])

chordExpansion = {
    'maj':[0,4,7],
    'min':[0,3,7],
    '7':[0,4,7,10],
    'maj7':[0,4,7,11],
    'm7':[0,3,7,10],
    'mM7':[0,3,7,11],
    '5':[0,7],
    '':[0]
}

function findKeys(final){
    exp = new Set(chordExpansion[final.type].map(x=>{
        return (x+revScale[final.root]) % 12
    }))
    // console.log(exp)
    res = new Set()
    for(var k=0;k<12;k++){
        if(exp.has((k+1)%12) || exp.has((k+3)%12) || exp.has((k+6)%12) || exp.has((k+10)%12))
            continue
        res.add(k)
    }
    // console.log(res)
    return res
}

findKeys({root:'G#',type:'maj'})



function goesWith(final, cluster){
    console.log('goesWith')
    base = revScale[final.root]
    chord = final.type
    exp = chordExpansion[chord].map(x=>{
        return (x+base) % 12
    })
    if(cluster.values().length)
        for(var i=0;exp[i];i++){
            if(cluster.has(exp[i])==false){
                console.log(chord + ' doesnt go with ')
                console.log(cluster)
                return false
            }
        }
    
    console.log(chord + ' goes with ')
    console.log(cluster)
    if(exp.length > cluster.values().length){
        PREVCLUSTER = new Set(exp)
        return true
    }
    PREVCLUSTER =  cluster
    return true

}


function getNotes(chord){
    
// console.log(chord)
    if(chord==null)
        return new Set()
    root = chord.root

    type = chord.type
    base = chord.bass
    
    // base += '2'
    // arr = new Set()
    // arr.add(root+'3')

    arr = new Set( chordExpansion[type].map(x=>{
        return scale[ ( x + revScale[root] ) % 12 ]+'3'
    }))
    
    // if(type=='5'){
    //     arr.add(scale[ (  revScale[root] + 7    ) % 12 ]+'3')
    // }
    // else if(type=='maj'){
    //     arr.add(scale[ (  revScale[root] + 4    ) % 12 ]+'3')
    //     arr.add(scale[ (  revScale[root] + 7    ) % 12 ]+'3')
    // }
    // else if(type=='maj7'){
    //     arr.add(scale[ (  revScale[root] + 4    ) % 12 ]+'3')
    //     arr.add(scale[ (  revScale[root] + 7    ) % 12 ]+'3')
    //     arr.add(scale[ (  revScale[root] + 11    ) % 12 ]+'3')
    // }
    // else if(type=='7'){
    //     arr.add(scale[ (  revScale[root] + 4    ) % 12 ]+'3')
    //     arr.add(scale[ (  revScale[root] + 7    ) % 12 ]+'3')
    //     arr.add(scale[ (  revScale[root] + 10    ) % 12 ]+'3')
    // }
    // else if(type=='min'){
    //     arr.add(scale[ (  revScale[root] + 3    ) % 12 ]+'3')
    //     arr.add(scale[ (  revScale[root] + 7    ) % 12 ]+'3')
    // }
    // else if(type=='m7'){
    //     arr.add(scale[ (  revScale[root] + 3    ) % 12 ]+'3')
    //     arr.add(scale[ (  revScale[root] + 7    ) % 12 ]+'3')
    //     arr.add(scale[ (  revScale[root] + 10    ) % 12 ]+'3')
    // }
    // else if(type=='mM7'){
    //     arr.add(scale[ (  revScale[root] + 3    ) % 12 ]+'3')
    //     arr.add(scale[ (  revScale[root] + 7    ) % 12 ]+'3')
    //     // arr.add(scale[ (  revScale[root] + 11    ) % 12 ]+'3')
    // }

    
    arr.add(base+'2')

    // console.log(arr)

    return arr
    
    
}


// releaseNotes(['C#','maj7/B'])

function combine(c1,c2){
    c1 = JSON.stringify(c1).split(',')
    c1[0] = c1[0].substring(1,2)
    
    
    if(c2==null){
        c1[1] = c1[1].substring(0,c1[1].length-1)
        if(c1[1][3]=='/'){
            b = c1[1].substring(4,c1[1].length)
            n = (12+revScale[b] - revScale[c1[0]])%12

            if(n==10){
                if(c1[1][1]=='a')
                    return c1[0]+'7'
                return c1[0]+'m7'
            }
            if(n==11){
                if(c1[1][1]=='a')
                    return c1[0]+'maj7'
                return c1[0]+'mM7'
            }
        }
        return c1[0]+c1[1]
        
        

        // return c1[0]+c1[1].substring(0,c1[1].length-1)
    }
    // Combine 2 chords c1, c2
    // Format: ['C','maj/G'],...
    // For now, remove '/G'
    // console.log(c1)
    c2 = JSON.stringify(c2).split(',')
    c2[0] = c2[0].substring(1,2)
    c1[1] = c1[1].substring(0,3)
    
    c2[1] = c2[1].substring(0,3)

    if(c1[1][0]=='5') c1[1]='5'
    if(c2[1][0]=='5') c2[1]='5'

    base1 = c1[0]
    base2 = c2[0]
    offset = (12+revScale[base2]-revScale[base1])%12

    chord = new Set()
    // console.log(c1,c2)
    if(c1[1]=='maj'){
        chord.add(0)
        chord.add(4)
        chord.add(7)
    }
    else if(c1[1]=='min'){
        chord.add(0)
        chord.add(3)
        chord.add(7)
    }
    else if(c1[1]=='5'){
        chord.add(0)
        chord.add(7)
    }

    if(c2[1]=='maj'){
        chord.add((0+offset)%12)
        chord.add((4+offset)%12)
        chord.add((7+offset)%12)
    }
    else if(c2[1]=='min'){
        chord.add((0+offset)%12)
        chord.add((3+offset)%12)
        chord.add((7+offset)%12)
    }
    else if(c2[1]=='5'){
        chord.add((0+offset)%12)
        chord.add((7+offset)%12)
    }

    arr=[]
    for(i of chord.values())
        arr.push(i)

    arr = arr.sort((a,b)=>a-b)

    // console.log(arr)
    
    if(JSON.stringify(arr)=='[0,4,7,10]')
        return base1+'7'
    if(JSON.stringify(arr)=='[0,4,7,11]')
        return base1+'maj7'
    if(JSON.stringify(arr)=='[0,3,7,10]')
        return base1+'m7'
    if(JSON.stringify(arr)=='[0,3,7,11]')
        return base1+'mM7'

    arr = arr.map(x=>{
        return (12+x-offset)%12
    })
    arr = arr.sort((a,b)=>a-b)

    if(JSON.stringify(arr)=='[0,4,7,10]')
        return base2+'7'
    if(JSON.stringify(arr)=='[0,4,7,11]')
        return base2+'maj7'
    if(JSON.stringify(arr)=='[0,3,7,10]')
        return base2+'m7'
    if(JSON.stringify(arr)=='[0,3,7,11]')
        return base2+'mM7'
    
    // alert(base1+c1[1])
    return base1+c1[1]
}

// console.log(combine(['C#','min'],['E','maj/B']))


function getVisual(tops){
    // Format of tops: [B2,E3,B3,...]
    str = ''
    if(tops.length==0) return str

    str = tops[0]
    i = 1
    num = tops[0][tops[0].length-1]
    prev = revScale[tops[0].substring(0,tops[0].length-1)]
    while(i<tops.length){
        cur = revScale[tops[i].substring(0,tops[i].length-1)]
        len = (12+cur-prev)%12
        str+=('-'.repeat(len*len))
        if(num!=tops[i][tops[i].length-1]){
            str+=' ||| '
            num = tops[i][tops[i].length-1]
        }
        prev = cur
        str+= tops[i]
        i+=1
        
    }
    return str
}

function decluster(tops){
    //Format = [[C3,-43],...]
    // console.log('declustering')
    // console.log(tops)
    arr = tops.map(x=>{
        return [x[0].substring(0,x[0].length-1),x[1]]
    })

    clusters = []
    i=0
    low=i;
    high=i;
    for(var i=0;i<tops.length;i++){
        if(i<tops.length-1 && revScale[arr[i+1][0]] == revScale[arr[i][0]] + 1){
            high++
            continue
        }

        clusters.push([low,high])
        high++
        low = high
    }

    // console.log(clusters)

    peaks = []

    for(cluster of clusters){
        low = cluster[0]
        high = cluster[1]
        orient = 'up'

        len = 0
        climb = 0
        let peak;

        for(var i=low;i<=high;i++,len++){
            if(orient=='up'){
                if(i==high){
                    peak = tops[i]
                    // peaks.push(peak)
                    break
                }
                if(arr[i+1][1] < arr[i][1]){
                    peak = tops[i]
                    // peaks.push(peak)
                    orient='down'
                }
                climb += Math.abs(arr[i+1][1] - arr[i][1])
                    
            }
            else{
                if(i<high && arr[i+1][1] > arr[i][1]){
                    // Finished a peak
                    // console.log('Found a peak')
                    // console.log(peak[0],Math.floor(climb),len)
                    if(climb/len > 7)
                        peaks.push(peak)
                    peak = null
                    len=0
                    climb=0
                    orient='up'
                }
                if(i<high)climb += Math.abs(arr[i+1][1] - arr[i][1])
            }
            
        }
        if(peak!=null)
            peaks.push(peak)
    }
    // console.log(peaks)
    return peaks
}

// decluster([['C3',30],['C#3',40],['E4',30],['F4',20],['F#4',50]])


function findTriad(res,resM=[]){
    res = res.concat(resM)
    // format = [G#,B,C#,D#,G#]
    // console.log('MY BASS IS',res[0])

    tones = res.map(x => {
        return (12+revScale[x] - revScale[res[0]])%12
    })

    thirdm=false
    thirdM=false
    fifth=false
    dom7=false
    maj7=false
    
    for(let t of tones){
        if(t==3){
            thirdm=true
        }
        else if(t==4){
            thirdM=true
        }
        else if(t==7){
            fifth=true
        }
        else if(t==10){
            dom7=true
        }
        else if(t==11){
            maj7=true
        }
    }
    if(thirdM){
        if(fifth){
            if(dom7){
                return ([res[0],'7'])
            }
            if(maj7){
                return ([res[0],'M7'])
            }

        }
        return([res[0],'maj'])
    }
    
    if(thirdm){
        if(fifth){
            if(dom7){
                return ([res[0],'m7'])
            }
            if(maj7){
                return ([res[0],'minM7'])
            }

        }
        return([res[0],'min'])
    }
    
    first5 = false
    if(fifth)
        first5 = true     
            

    if(res.length==1 || res[1]==res[0]){
        if(first5)
            return([res[0],'5'])
            
        return([res[0],'/'])
    }

    tones = res.map(x => {
        return (12+revScale[x] - revScale[res[1]])%12
    })

    thirdm=false
    thirdM=false
    fifth=false

    for(let t of tones){
        if(t==3){
            thirdm=true
        }
        else if(t==4){
            thirdM=true
        }
        else if(t==7){
            fifth=true
        }
    }
    
    if(thirdM){
        return([res[1],'maj'])
    }
    else if(thirdm){
        return([res[1],'min'])
    }
    
    if(fifth && !first5){
        return([res[1],'5'])
    }

    if(first5){
        return([res[0],'5'])
    }

    return([res[0],'/',res[1]])


    


}


harmonize(['C','G#','E','A'])



</script>
